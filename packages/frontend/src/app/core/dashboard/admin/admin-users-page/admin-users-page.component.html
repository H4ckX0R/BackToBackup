<main class="h-screen flex flex-col">
    <app-navbar></app-navbar>
    <div class="flex-1 overflow-y-auto">
        <p-table [value]="users" stripedRows [rowHover]="true" [paginator]="true" [rows]="10"
            [rowsPerPageOptions]="[10,20,50]" [totalRecords]="totalElements" selectionMode="single"
            [resizableColumns]="true" [showCurrentPageReport]="true" [scrollable]="true" scrollHeight="flex"
            [currentPageReportTemplate]="'Viendo del {first} al {last} de {totalRecords} usuarios'"
            [showGridlines]="true" [lazy]="true" (onLazyLoad)="onLazyLoad($event)" (onRowSelect)="onRowSelect($event)"
            [(selection)]="selectedUser" [metaKeySelection]="false">
            <ng-template #caption>
                <div class="flex items-center justify-between">
                    <span class="text-xl font-bold">Usuarios</span>
                    <p-button label="Nuevo usuario" severity="success" (onClick)="modalNuevoUsuario()" [disabled]="!puedoModificar">
                        <ng-template pTemplate="icon">
                            <ng-icon name="bootstrapPersonPlusFill" size="20"></ng-icon>
                        </ng-template>
                    </p-button>
                </div>
            </ng-template>
            <ng-template #header>
                <tr>
                    <th pResizableColumn>Nombre</th>
                    <th pResizableColumn>Apellidos</th>
                    <th pResizableColumn>Email</th>
                    <th pResizableColumn>Roles</th>
                </tr>
            </ng-template>
            <ng-template #body let-user>
                <tr [pSelectableRow]="user">
                    <td>{{ user.firstName }}</td>
                    <td>{{ user.lastName }}</td>
                    <td>{{ user.email }}</td>
                    <td>
                        @for (role of user.roles; track $index) {
                        <p-tag [value]="role.name"></p-tag>
                        }
                    </td>
                </tr>
            </ng-template>
        </p-table>
    </div>
</main>

<p-dialog [header]="(modalEditUserId ? 'Editar' : 'Nuevo') + ' usuario'" [(visible)]="modalEditVisible" styleClass="m-5 w-full md:w-1/2 lg:w-1/3"
    [modal]="true" [draggable]="false" [dismissableMask]="true" resizable="false" blockScroll="true"
    (onHide)="deseleccionarUsuario()">

    <ng-template #content styleClass="overflow-y-visible">
        <form class="flex flex-col gap-2 overflow-y-visible" [formGroup]="userForm">
            <div>
                <label>Nombre</label>
                <input type="text" pInputText class="w-full" variant="filled" formControlName="firstName" />
            </div>
            <div>
                <label>Apellidos</label>
                <input type="text" pInputText class="w-full" variant="filled" formControlName="lastName" />
            </div>
            <div>
                <label>Email</label>
                <input type="email" pInputText class="w-full" variant="filled" formControlName="email" />
            </div>
            <div>
                <label>Roles</label>
                <p-multiselect [options]="rolesList" formControlName="roles" placeholder="Sin roles"
                    optionLabel="name" display="chip" styleClass="w-full" variant="filled" showToggleAll="false"
                    resetFilterOnHide="true">
                    <ng-template #chipicon>
                        <ng-icon name="bootstrapXCircle" size="20" class="-mt-0.5"></ng-icon>
                    </ng-template>
                </p-multiselect>

            </div>
        </form>
    </ng-template>

    <ng-template #footer>
        <div class="flex justify-between gap-2 w-full">
            <p-button label="Eliminar" severity="danger" (onClick)="confirmEliminar($event)" [disabled]="!modalEditUserId || !puedoEliminar">
                <ng-template pTemplate="icon">
                    <ng-icon name="bootstrapPersonFillDash" size="20"></ng-icon>
                </ng-template>
            </p-button>
            <p-button [label]="modalEditUserId ? 'Guardar' : 'Crear'" severity="success" (onClick)="guardarUsuario()" [disabled]="!puedoModificar || userForm.invalid">
                <ng-template pTemplate="icon">
                    <ng-icon name="bootstrapPersonFillCheck" size="20"></ng-icon>
                </ng-template>
            </p-button>
        </div>
    </ng-template>

    <ng-template #closeicon>
        <ng-icon name="bootstrapXLg" size="20" class="mt-1.5"></ng-icon>
    </ng-template>
</p-dialog>


<p-confirmpopup>
    <ng-template #content>
        <ng-icon name="bootstrapExclamationTriangle" size="30" color="#ef4444"></ng-icon>
        <p>¿Estás seguro de eliminar al usuario?</p>
    </ng-template>
    <ng-template #accepticon>
        <ng-icon name="bootstrapTrashFill" size="20"></ng-icon>
    </ng-template>
    <ng-template #rejecticon>
        <ng-icon name="bootstrapPersonFill" size="20"></ng-icon>
    </ng-template>
</p-confirmpopup>